pipeline {
    agent any
    
    environment {
        GIT_REPO_URL = 'https://github.com/Ahmedhossam2003-ui/my-project.git'
        GIT_BRANCH = 'main'
        
        EC2_HOST = '13.53.51.9' #]Ø¯Ù‡ Ø§Ù„ public id
        EC2_USER = 'ec2-user'
        
        PLAYBOOK_PATH = 'nexus.yaml'
        INVENTORY_PATH = 'inventory.ini'
        
        REMOTE_WORKSPACE = '/home/ec2-user/workspace'
    }
    
    stages {

        stage('Install Ansible on EC2 Instance') {
            steps {
                script {
                    echo "ğŸ”§ ØªØ«Ø¨ÙŠØª Ansible Ø¹Ù„Ù‰ Ø§Ù„Ù€ instance..."
                    withCredentials([sshUserPrivateKey(credentialsId: 'ec2-ssh-key', keyFileVariable: 'SSH_KEY')]) {
                        sh """
                            ssh -o StrictHostKeyChecking=no -i "${SSH_KEY}" ${EC2_USER}@${EC2_HOST} '
                                sudo yum update -y

                                if ! command -v ansible &> /dev/null; then
                                    sudo amazon-linux-extras install ansible2 -y || sudo yum install ansible -y
                                fi

                                sudo yum install -y git
                            '
                        """
                    }
                }
            }
        }
        
        stage('Clone Repository on EC2 Instance') {
            steps {
                script {
                    withCredentials([sshUserPrivateKey(credentialsId: 'ec2-ssh-key', keyFileVariable: 'SSH_KEY')]) {
                        sh """
                            ssh -o StrictHostKeyChecking=no -i "${SSH_KEY}" ${EC2_USER}@${EC2_HOST} '
                                rm -rf ${REMOTE_WORKSPACE}
                                mkdir -p ${REMOTE_WORKSPACE}
                                git clone -b ${GIT_BRANCH} ${GIT_REPO_URL} ${REMOTE_WORKSPACE}
                                ls -la ${REMOTE_WORKSPACE}
                            '
                        """
                    }
                }
            }
        }

        stage('Verify Ansible Files') {
            steps {
                script {
                    withCredentials([sshUserPrivateKey(credentialsId: 'ec2-ssh-key', keyFileVariable: 'SSH_KEY')]) {
                        sh """
                            ssh -o StrictHostKeyChecking=no -i "${SSH_KEY}" ${EC2_USER}@${EC2_HOST} << 'EOF'
cd /home/ec2-user/workspace

if [ -f nexus.yaml ]; then
    echo "âœ… Playbook nexus.yaml Ù…ÙˆØ¬ÙˆØ¯"
else
    echo "âŒ Playbook nexus.yaml ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"
    exit 1
fi

if [ -f inventory.ini ]; then
    echo "âœ… Inventory.ini Ù…ÙˆØ¬ÙˆØ¯"
else
    echo "âŒ Inventory.ini ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"
    exit 1
fi
EOF
                        """
                    }
                }
            }
        }

stage('Fix inventory for local') {
    steps {
        withCredentials([sshUserPrivateKey(credentialsId: 'ec2-ssh-key', keyFileVariable: 'SSH_KEY')]) {
            sh """
                ssh -o StrictHostKeyChecking=no -i "${SSH_KEY}" ${EC2_USER}@${EC2_HOST} '
                    echo "[nexus]" > /home/ec2-user/workspace/inventory.ini
                    echo "nexus-server ansible_host=127.0.0.1 ansible_connection=local ansible_user=ec2-user ansible_ssh_private_key_file=/home/ec2-user/key" >> /home/ec2-user/workspace/inventory.ini
                '
            """
        }
    }
}


stage('Run Ansible Playbook') {
    steps {
        script {
            echo "ğŸš€ ØªØ´ØºÙŠÙ„ Ansible Playbook Ø¹Ù„Ù‰ Ø§Ù„Ù€ EC2..."
            withCredentials([sshUserPrivateKey(credentialsId: 'ec2-ssh-key', keyFileVariable: 'SSH_KEY')]) {
                sh """
                    ssh -o StrictHostKeyChecking=no -i "${SSH_KEY}" ${EC2_USER}@${EC2_HOST} '
                        cd ${REMOTE_WORKSPACE}
                        ansible-playbook -i inventory.ini nexus.yaml -v
                    '
                """
            }
        }
    }
}




    }  // â† â† â† Ø¯ÙŠ ÙƒØ§Ù†Øª Ù†Ø§Ù‚ØµØ©

    post {
        success {
            echo 'âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ansible Playbook Ø¨Ù†Ø¬Ø§Ø­!'
        }
        failure {
            echo 'âŒ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Pipeline!'
        }
        always {
            echo 'ğŸ Ø§Ù†ØªÙ‡Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙ†ÙÙŠØ°'
        }
    }
}
