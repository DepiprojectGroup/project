---
- name: Setup Nexus Repository Manager on EC2 with Docker
  hosts: nexus
  become: yes
  gather_facts: no
  vars:
    nexus_port: 8081
    docker_port: 8082
    nexus_data_dir: "/opt/nexus-data"

  tasks:
    - name: Install Docker
      raw: |
        sudo yum install -y docker
      args:
        executable: /bin/bash

    - name: Start and enable Docker service
      raw: |
        sudo systemctl start docker
        sudo systemctl enable docker
      args:
        executable: /bin/bash

    - name: Add ec2-user to docker group
      raw: sudo usermod -aG docker ec2-user
      args:
        executable: /bin/bash

    - name: Create Nexus data directory
      raw: sudo mkdir -p {{ nexus_data_dir }} && sudo chown -R 200:200 {{ nexus_data_dir }} && sudo chmod -R 755 {{ nexus_data_dir }}
      args:
        executable: /bin/bash

    - name: Stop and remove old Nexus container if exists
      raw: sudo docker stop nexus 2>/dev/null || true && sudo docker rm nexus 2>/dev/null || true
      args:
        executable: /bin/bash

    - name: Run Nexus container
      raw: |
        sudo docker run -d \
          --name nexus \
          --restart always \
          -p {{ nexus_port }}:8081 \
          -p {{ docker_port }}:8082 \
          -v {{ nexus_data_dir }}:/nexus-data \
          -e INSTALL4J_ADD_VM_PARAMS="-Xms512m -Xmx768m -XX:MaxDirectMemorySize=1g" \
          sonatype/nexus3:latest
      args:
        executable: /bin/bash

    - name: Wait for Nexus to initialize
      raw: |
        echo "Waiting for Nexus to start (this takes 2-3 minutes)..."
        for i in {1..60}; do
          if sudo docker exec nexus test -f /nexus-data/admin.password 2>/dev/null; then
            echo "Nexus is ready!"
            break
          fi
          echo -n "."
          sleep 5
        done
      args:
        executable: /bin/bash

    - name: Get admin password
      raw: sudo docker exec nexus cat /nexus-data/admin.password 2>/dev/null || echo 'Not ready yet'
      register: admin_password
      args:
        executable: /bin/bash

    - name: Display Nexus information
      debug:
        msg:
          - "================================================================"
          - "Nexus is accessible at http://{{ ansible_host }}:{{ nexus_port }}"
          - "Docker registry: http://{{ ansible_host }}:{{ docker_port }}"
          - "Initial admin password: {{ admin_password.stdout }}"
          - "================================================================"
